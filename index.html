<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ–ä¸€æ–æŠ½å¡æ´»å‹•</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #cardResult img { width: 200px; margin-top: 10px; }
    #cardCollection img { width: 80px; margin: 5px; }
    #cardCollection { margin-top: 30px; }
    #info { margin-top: 15px; font-weight: bold; }
    #startBtn { font-size: 20px; padding: 10px 20px; margin: 20px auto; cursor: pointer; }
  </style>
</head>
<body>
  <h1>æ–ä¸€æ–ä¾†æŠ½å¡ï¼</h1>
  <p>è«‹å…ˆé»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿå‹•æ–ä¸€æ–åŠŸèƒ½ï¼Œç„¶å¾Œæ–å‹•æ‰‹æ©ŸæŠ½å¡ï¼Œä¸€å¤©åªèƒ½æŠ½ä¸€æ¬¡å–”ï¼</p>

  <button id="startBtn">é–‹å§‹æ–ä¸€æ–æŠ½å¡</button>

  <div id="cardResult"></div>
  <div id="info"></div>

  <h2>ä½ çš„å¡ç‰‡æ”¶è—ç‰†</h2>
  <div id="cardCollection"></div>

  <script>
    // å¡ç‰‡è³‡æ–™
    const cards = [
      { name: "å¡ç‰‡A", img: "1.jpg" },
      { name: "å¡ç‰‡B", img: "2.jpg" },
      { name: "å¡ç‰‡C", img: "3.jpg" },
      { name: "å¡ç‰‡D", img: "4.jpg" },
      { name: "å¡ç‰‡E", img: "5.jpg" },
      { name: "å¡ç‰‡F", img: "6.jpg" },
    ];

    const SHAKE_THRESHOLD = 15;
    let shaking = false;

    // è®€å–æœ¬åœ°ç´€éŒ„
    function getCardHistory() {
      return JSON.parse(localStorage.getItem("cardHistory") || "{}");
    }

    // å„²å­˜å¡ç‰‡ç´€éŒ„
    function saveCardHistory(date, cardIndex) {
      let history = getCardHistory();
      if (!history[date]) history[date] = [];
      history[date].push(cardIndex);
      localStorage.setItem("cardHistory", JSON.stringify(history));
    }

    // åˆ¤æ–·ä»Šå¤©æ˜¯å¦å·²æŠ½å¡
    function hasDrawToday() {
      const today = new Date().toISOString().slice(0, 10);
      const history = getCardHistory();
      return history[today] && history[today].length > 0;
    }

    // é¡¯ç¤ºæŠ½å¡çµæœ
    function showCard(cardIndex) {
      const card = cards[cardIndex];
      const cardResultDiv = document.getElementById("cardResult");
      cardResultDiv.innerHTML = `
        <h3>æ­å–œä½ æŠ½åˆ°ï¼š${card.name}</h3>
        <img src="${card.img}" alt="${card.name}" />
      `;
      document.getElementById("info").textContent = "å†æŠ½ä¸€æ¬¡ä¹Ÿæ²’å•é¡Œå–” ğŸ‰";
    }

    // é¡¯ç¤ºæ”¶è—ç‰†
    function showCardCollection() {
      const history = getCardHistory();
      const collectionDiv = document.getElementById("cardCollection");
      collectionDiv.innerHTML = "";

      const allCards = [];
      for (const date in history) {
        allCards.push(...history[date]);
      }

      const uniqueCards = [...new Set(allCards)];

      if (uniqueCards.length === 0) {
        collectionDiv.textContent = "ä½ é‚„æ²’æœ‰æŠ½éå¡ç‰‡å–”ï½";
        return;
      }

      uniqueCards.forEach(idx => {
        const card = cards[idx];
        const img = document.createElement("img");
        img.src = card.img;
        img.alt = card.name;
        collectionDiv.appendChild(img);
      });
    }

    // æŠ½å¡
    function doDrawCard() {
  const cardIndex = Math.floor(Math.random() * cards.length);
  const today = new Date().toISOString().slice(0, 10);
  saveCardHistory(today, cardIndex);
  showCard(cardIndex);
  showCardCollection();
}


    // æ–ä¸€æ–è™•ç†å‡½å¼
    function shakeHandler(event) {
      if (shaking) return;
      const acc = event.accelerationIncludingGravity;
      if (!acc) return;
      const totalAcc = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
      if (totalAcc > SHAKE_THRESHOLD) {
        shaking = true;
        doDrawCard();
        setTimeout(() => { shaking = false; }, 1500);
      }
    }

    // å•Ÿå‹•æ–ä¸€æ–åŠŸèƒ½ï¼ˆiOS éœ€å…ˆè«‹æ±‚æ¬Šé™ï¼‰
    const startBtn = document.getElementById("startBtn");
    startBtn.addEventListener("click", () => {
      if (typeof DeviceMotionEvent !== 'undefined' && 
          typeof DeviceMotionEvent.requestPermission === 'function') {
        // iOS 13+ éœ€è¦å…ˆè«‹æ±‚æ¬Šé™
        DeviceMotionEvent.requestPermission()
          .then(permissionState => {
            if (permissionState === 'granted') {
              window.addEventListener('devicemotion', shakeHandler);
              startBtn.style.display = 'none';
              alert("æ–ä¸€æ–åŠŸèƒ½å·²å•Ÿå‹•ï¼Œè«‹æ–å‹•æ‰‹æ©Ÿè©¦è©¦çœ‹ï¼");
            } else {
              alert("è«‹å…è¨±æ–ä¸€æ–æ¬Šé™æ‰èƒ½ä½¿ç”¨ï¼");
            }
          })
          .catch(console.error);
      } else {
        // éiOSæˆ–ä¸éœ€æ¬Šé™ï¼Œç›´æ¥ç¶å®š
        window.addEventListener('devicemotion', shakeHandler);
        startBtn.style.display = 'none';
        alert("æ–ä¸€æ–åŠŸèƒ½å·²å•Ÿå‹•ï¼Œè«‹æ–å‹•æ‰‹æ©Ÿè©¦è©¦çœ‹ï¼");
      }
    });

    // åˆå§‹é¡¯ç¤ºæ”¶è—ç‰†
    showCardCollection();
  </script>
</body>
</html>

