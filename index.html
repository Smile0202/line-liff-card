<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>搖一搖抽卡活動</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #cardResult img { width: 200px; margin-top: 10px; }
    #cardCollection img { width: 80px; margin: 5px; }
    #cardCollection { margin-top: 30px; }
    #info { margin-top: 15px; font-weight: bold; }
    #startBtn { font-size: 20px; padding: 10px 20px; margin: 20px auto; cursor: pointer; }
  </style>
</head>
<body>
  <h1>搖一搖來抽卡！</h1>
  <p>請先點擊下方按鈕啟動搖一搖功能，然後搖動手機抽卡，一天只能抽一次喔！</p>

  <button id="startBtn">開始搖一搖抽卡</button>

  <div id="cardResult"></div>
  <div id="info"></div>

  <h2>你的卡片收藏牆</h2>
  <div id="cardCollection"></div>

  <script>
    // 卡片資料
    const cards = [
      { name: "卡片A", img: "1.jpg" },
      { name: "卡片B", img: "2.jpg" },
      { name: "卡片C", img: "3.jpg" },
      { name: "卡片D", img: "4.jpg" },
      { name: "卡片E", img: "5.jpg" },
      { name: "卡片F", img: "6.jpg" },
    ];

    const SHAKE_THRESHOLD = 15;
    let shaking = false;

    // 讀取本地紀錄
    function getCardHistory() {
      return JSON.parse(localStorage.getItem("cardHistory") || "{}");
    }

    // 儲存卡片紀錄
    function saveCardHistory(date, cardIndex) {
      let history = getCardHistory();
      if (!history[date]) history[date] = [];
      history[date].push(cardIndex);
      localStorage.setItem("cardHistory", JSON.stringify(history));
    }

    // 判斷今天是否已抽卡
    function hasDrawToday() {
      const today = new Date().toISOString().slice(0, 10);
      const history = getCardHistory();
      return history[today] && history[today].length > 0;
    }

    // 顯示抽卡結果
    function showCard(cardIndex) {
      const card = cards[cardIndex];
      const cardResultDiv = document.getElementById("cardResult");
      cardResultDiv.innerHTML = `
        <h3>恭喜你抽到：${card.name}</h3>
        <img src="${card.img}" alt="${card.name}" />
      `;
      document.getElementById("info").textContent = "今天已打卡，明天再來抽卡吧！";
    }

    // 顯示收藏牆
    function showCardCollection() {
      const history = getCardHistory();
      const collectionDiv = document.getElementById("cardCollection");
      collectionDiv.innerHTML = "";

      const allCards = [];
      for (const date in history) {
        allCards.push(...history[date]);
      }

      const uniqueCards = [...new Set(allCards)];

      if (uniqueCards.length === 0) {
        collectionDiv.textContent = "你還沒有抽過卡片喔～";
        return;
      }

      uniqueCards.forEach(idx => {
        const card = cards[idx];
        const img = document.createElement("img");
        img.src = card.img;
        img.alt = card.name;
        collectionDiv.appendChild(img);
      });
    }

    // 抽卡
    function doDrawCard() {
      if (hasDrawToday()) {
        alert("今天已經抽過卡囉，明天再來！");
        return;
      }
      const cardIndex = Math.floor(Math.random() * cards.length);
      const today = new Date().toISOString().slice(0, 10);
      saveCardHistory(today, cardIndex);
      showCard(cardIndex);
      showCardCollection();
    }

    // 搖一搖處理函式
    function shakeHandler(event) {
      if (shaking) return;
      const acc = event.accelerationIncludingGravity;
      if (!acc) return;
      const totalAcc = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
      if (totalAcc > SHAKE_THRESHOLD) {
        shaking = true;
        doDrawCard();
        setTimeout(() => { shaking = false; }, 1500);
      }
    }

    // 啟動搖一搖功能（iOS 需先請求權限）
    const startBtn = document.getElementById("startBtn");
    startBtn.addEventListener("click", () => {
      if (typeof DeviceMotionEvent !== 'undefined' && 
          typeof DeviceMotionEvent.requestPermission === 'function') {
        // iOS 13+ 需要先請求權限
        DeviceMotionEvent.requestPermission()
          .then(permissionState => {
            if (permissionState === 'granted') {
              window.addEventListener('devicemotion', shakeHandler);
              startBtn.style.display = 'none';
              alert("搖一搖功能已啟動，請搖動手機試試看！");
            } else {
              alert("請允許搖一搖權限才能使用！");
            }
          })
          .catch(console.error);
      } else {
        // 非iOS或不需權限，直接綁定
        window.addEventListener('devicemotion', shakeHandler);
        startBtn.style.display = 'none';
        alert("搖一搖功能已啟動，請搖動手機試試看！");
      }
    });

    // 初始顯示收藏牆
    showCardCollection();
  </script>
</body>
</html>

